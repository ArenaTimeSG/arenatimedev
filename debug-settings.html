<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Settings - Mercado Pago</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { background-color: #ffebee; border-color: #f44336; }
        .success { background-color: #e8f5e8; border-color: #4caf50; }
        .info { background-color: #e3f2fd; border-color: #2196f3; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background-color: #2196f3; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #1976d2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Settings - Mercado Pago</h1>
        
        <div class="section info">
            <h3>üìã Instru√ß√µes</h3>
            <p>1. Abra o console do navegador (F12)</p>
            <p>2. Clique nos bot√µes abaixo para testar</p>
            <p>3. Verifique os logs no console</p>
        </div>

        <div class="section">
            <h3>üîë Testar Configura√ß√µes do Usu√°rio</h3>
            <button onclick="testUserSettings()">Buscar Configura√ß√µes do Usu√°rio</button>
            <div id="userSettingsResult"></div>
        </div>

        <div class="section">
            <h3>üí≥ Testar Cria√ß√£o de Prefer√™ncia</h3>
            <button onclick="testCreatePreference()">Testar Cria√ß√£o de Prefer√™ncia</button>
            <div id="preferenceResult"></div>
        </div>

        <div class="section">
            <h3>üóÑÔ∏è Verificar Tabela Settings</h3>
            <button onclick="checkSettingsTable()">Verificar Estrutura da Tabela</button>
            <div id="tableResult"></div>
        </div>
    </div>

    <script>
        // Configura√ß√µes do Supabase
        const SUPABASE_URL = 'https://ogzlvdpdngwbgqeiayec.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nemx2ZHBkbmd3YmdxZWlheWVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0OTAzNjksImV4cCI6MjA3NjA2NjM2OX0.KSQVdj50BY5s1mBsU6B3Ut9t7xfFW7z5LsPx4JPHYeg';

        // Inicializar Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function testUserSettings() {
            const resultDiv = document.getElementById('userSettingsResult');
            resultDiv.innerHTML = '<p>üîÑ Buscando configura√ß√µes...</p>';
            
            try {
                // Buscar usu√°rio atual
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erro ao buscar usu√°rio:</h4><pre>${JSON.stringify(userError, null, 2)}</pre></div>`;
                    return;
                }

                if (!user) {
                    resultDiv.innerHTML = '<div class="error"><h4>‚ùå Usu√°rio n√£o autenticado</h4><p>Fa√ßa login primeiro</p></div>';
                    return;
                }

                console.log('üë§ Usu√°rio:', user);

                // Buscar configura√ß√µes
                const { data: settings, error: settingsError } = await supabaseClient
                    .from('settings')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (settingsError) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erro ao buscar configura√ß√µes:</h4><pre>${JSON.stringify(settingsError, null, 2)}</pre></div>`;
                    return;
                }

                console.log('‚öôÔ∏è Configura√ß√µes:', settings);

                // Verificar configura√ß√µes do Mercado Pago
                const mpConfig = {
                    enabled: settings?.mercado_pago_enabled || false,
                    accessToken: settings?.mercado_pago_access_token || '',
                    publicKey: settings?.mercado_pago_public_key || '',
                    webhookUrl: settings?.mercado_pago_webhook_url || ''
                };

                console.log('üí≥ Configura√ß√µes Mercado Pago:', mpConfig);

                let status = 'success';
                let message = '‚úÖ Configura√ß√µes encontradas!';
                
                if (!mpConfig.enabled) {
                    status = 'error';
                    message = '‚ùå Mercado Pago n√£o est√° habilitado';
                } else if (!mpConfig.accessToken) {
                    status = 'error';
                    message = '‚ùå Access Token n√£o configurado';
                } else if (!mpConfig.publicKey) {
                    status = 'error';
                    message = '‚ùå Public Key n√£o configurada';
                }

                resultDiv.innerHTML = `
                    <div class="${status}">
                        <h4>${message}</h4>
                        <h5>üë§ Usu√°rio ID:</h5>
                        <pre>${user.id}</pre>
                        <h5>‚öôÔ∏è Configura√ß√µes Completas:</h5>
                        <pre>${JSON.stringify(settings, null, 2)}</pre>
                        <h5>üí≥ Configura√ß√µes Mercado Pago:</h5>
                        <pre>${JSON.stringify(mpConfig, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå Erro:', error);
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erro inesperado:</h4><pre>${JSON.stringify(error, null, 2)}</pre></div>`;
            }
        }

        async function testCreatePreference() {
            const resultDiv = document.getElementById('preferenceResult');
            resultDiv.innerHTML = '<p>üîÑ Testando cria√ß√£o de prefer√™ncia...</p>';
            
            try {
                // Buscar usu√°rio atual
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError || !user) {
                    resultDiv.innerHTML = '<div class="error"><h4>‚ùå Usu√°rio n√£o autenticado</h4></div>';
                    return;
                }

                const testData = {
                    owner_id: user.id,
                    booking_id: 'test-booking-' + Date.now(),
                    price: 10.00,
                    items: [{
                        title: 'Teste de Configura√ß√£o',
                        quantity: 1,
                        unit_price: 10.00
                    }],
                    return_url: window.location.origin + '/payment/success'
                };

                console.log('üì§ Dados sendo enviados:', testData);

                const response = await fetch(`${SUPABASE_URL}/functions/v1/create-payment-preference`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                console.log('üì• Resposta:', result);

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Prefer√™ncia criada com sucesso!</h4>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Erro ao criar prefer√™ncia:</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå Erro:', error);
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erro inesperado:</h4><pre>${JSON.stringify(error, null, 2)}</pre></div>`;
            }
        }

        async function checkSettingsTable() {
            const resultDiv = document.getElementById('tableResult');
            resultDiv.innerHTML = '<p>üîÑ Verificando estrutura da tabela...</p>';
            
            try {
                // Buscar usu√°rio atual
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError || !user) {
                    resultDiv.innerHTML = '<div class="error"><h4>‚ùå Usu√°rio n√£o autenticado</h4></div>';
                    return;
                }

                // Tentar buscar todas as colunas da tabela settings
                const { data: allSettings, error: allError } = await supabaseClient
                    .from('settings')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (allError) {
                    resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erro ao buscar dados:</h4><pre>${JSON.stringify(allError, null, 2)}</pre></div>`;
                    return;
                }

                // Verificar se as colunas do Mercado Pago existem
                const mpColumns = [
                    'mercado_pago_enabled',
                    'mercado_pago_access_token', 
                    'mercado_pago_public_key',
                    'mercado_pago_webhook_url'
                ];

                const existingColumns = mpColumns.filter(col => allSettings.hasOwnProperty(col));
                const missingColumns = mpColumns.filter(col => !allSettings.hasOwnProperty(col));

                resultDiv.innerHTML = `
                    <div class="info">
                        <h4>üìä Estrutura da Tabela Settings</h4>
                        <h5>‚úÖ Colunas do Mercado Pago encontradas:</h5>
                        <pre>${JSON.stringify(existingColumns, null, 2)}</pre>
                        <h5>‚ùå Colunas do Mercado Pago ausentes:</h5>
                        <pre>${JSON.stringify(missingColumns, null, 2)}</pre>
                        <h5>üìã Todas as colunas dispon√≠veis:</h5>
                        <pre>${JSON.stringify(Object.keys(allSettings), null, 2)}</pre>
                        <h5>üíæ Dados completos:</h5>
                        <pre>${JSON.stringify(allSettings, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                console.error('‚ùå Erro:', error);
                resultDiv.innerHTML = `<div class="error"><h4>‚ùå Erro inesperado:</h4><pre>${JSON.stringify(error, null, 2)}</pre></div>`;
            }
        }
    </script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</body>
</html>
